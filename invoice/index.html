<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <title>Invoice Edit | Download</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@500&display=swap');
        body{
            font-family: 'Open Sans', sans-serif;
        }    
    </style>
</head>
<body style="background-color: rgb(200, 237, 238);">

    <div class="container bg-transparent p-lg-5">
    <div class="bg-white mx-lg-5" id="invoicemain">
            
            <div class="row p-lg-5 pt-lg-4 p-3">
                <div class="col-9">
                <h4 class="pb-4"><span style="border-radius: 4px; padding: 2px 8px 4px; background-color: rgb(247, 43, 43); color: #fff;"> DUE</span>
                    <span style="padding: 0px 10px; font-weight: bold;" >Invoice</span></h4>
                <p class="btn btn-outline-secondary disabled">Thank you for your purchase. Timely payment will be appreciated. </p>
            </div>
            <div class="col-3 mb-0" style="border: rgb(172, 169, 169) dashed;">
                <div class="text-center"><img src="" alt="Your Logo Here"></div>               
            </div>
        </div>

        <form>
            <div class="row px-5">
                <div class="col-3">
                    <label for="invoiceno">Invoice No</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                          <div class="input-group-text">#</div>
                        </div>
                        <input type="text" class="form-control" id="invoiceno" placeholder="" value="#INV-694">
                    </div>
                </div>

                <div class="col-9 d-flex justify-content-end pr-0">
                    <div class="col-4">
                        <label for="lang">Language</label>
                        <div class="form-group bd-light">
                            <select class="form-control" id="lang">
                                <option>English (US)</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-6 pr-0">
                        <label for="currency">Currency</label>
                        <div class="form-group">
                            <select class="form-control" id="currency" onchange="currencyFunc(value)" >
                                <option value="INR">Indian Rupee - INR</option>
                                <option value="GBP">British Pound - GBP</option>
                                <option value="USD">U.S. dollar - USD</option>
                                <option value="AUD"> Australian dollars - AUD</option>
                            </select>
                        </div>
                    </div>
                </div>
                <br>
            </div>
            <hr class="mx-5 my-2">

            <div class="row mx-5 ">
                <div class="col-lg-5">
                    <div class="row">
                        <p><span class="font-weight-bold">From</span>
                          <br>
                          Your Business Inc,
                          <br>
                          Your Address
                          <br>
                          City & ZIP, Your Country
                        </p>
                    </div>
                    
                    <div class="row pt-1">
                        <p class="font-weight-bold mb-1">To</p>
                        <textarea class="form-control" style="background-color: #e9ecef;" id="toAddress" id="exampleFormControlTextarea1" rows="3"></textarea>
                    </div>
                </div>
                <div class="col-lg-3"></div>
                <div class="col-lg-4">                   
                    
                    <label for="date">Date</label>
                    <div class="input-group date" id="datepicker">
                        <input type="text" class="form-control">
                        <span class="input-group-append">
                            <span class="input-group-text bg-white">
                                <i class="fa fa-calendar"></i>
                            </span>
                        </span>
                    </div>

                    <label for="invoicedue">Invoice Due</label>
                    <div class="form-group ">
                        <select class="form-control" id="invoicedue">
                            <option>After 5 Days</option>
                            <option>After 10 Days</option>
                            <option>After 15 Days</option>
                            <option>After 20 Days</option>
                            <option>After 30 Days</option>
                        </select>
                    </div>

                    <label for="purchaseno">Purchase Order Number</label>
                    <div class="form-group">
                        <input type="text" class="form-control" id="purchaseno" value="PQ-123">
                    </div>
                </div>
            </div>
        </form>

        <hr class="mx-5 my-0">

        <form>
            <div class="row mx-5 mt-0">                
              <table class="table table-borderless pb-0 mb-0" id="items">
                <thead class="pt-2 border-bottom">
                  <tr>
                    <th scope="col" class="col-7">Name<i class="bi bi-clipboard"></i></th>
                    <th scope="col" class="text-right">Quantity</th>
                    <th scope="col" class="text-right">Rate</th>
                    <th scope="col" class="text-right">Amount</th>
                  </tr>
                </thead>

                <tbody class="table-body">
                    <tr class="item-row">
                        <td>
                            <div class="form-group">
                                <textarea class="form-control" id="itemName" rows="2" placeholder="Item Decription"></textarea>
                                <button class="btn btn-outline-secondary justify-content-end deleteRow" style="border: 1px solid #ced4da;"><i class="fa fa-times"></i></button>
                                <button class="btn btn-outline-secondary ml-1"  style="border: 1px solid #ced4da;" onclick="duplicate()"><i class="fa fa-copy"></i></button>
                            </div> 
                        </td>
                        <td>
                            <div class="form-group">
                                <input type="text" class="form-control text-right" id="quantity" onblur="Calculate();" value="0.00" required>
                            </div> 
                        </td>
                        <td>
                            <div class="form-group">
                                <input type="text" class="form-control text-right" id="rate" onblur="Calculate();" value="0.00" required>
                            </div> 
                        </td>
                        <td>
                            <div class="form-group">
                                <input type="text" class="form-control text-right" id="amount" value="" readonly>
                            </div> 
                        </td>
                    </tr>

                    <tr class="border-top my-0" id="hiderow">
                        <td colspan="4"><a class="btn btn-secondary" id="newLine" onclick="addLine()">New Line</a></td>
                    </tr>

                </tbody>
              </table>
            </div>

            <div class="row mx-5 pb-4" style="margin-top: -10px!important;">
                <div class="col-md-6"></div>
                
                <div class="col-md-6 mr-0">
                  <div class="row">
                      <div class="col-6">Sub Total</div>
                      <div class="col-6 text-right"><span id="subtotal" value=""></span> </div>
                  </div>
                  <hr>
                  <div class="row">
                      <div class="col-6">
                        <span class="border border-secondary p-1 mr-0">Value Added Tax</span>
                        <span class="border border-secondary p-1 border-left-0" style="margin-left: -4px;">20%</span></div>
                      <div class="col-6 text-right"><span id="taxAmount"></span></div>
                  </div>
                  <hr>
                  <div class="row pb-3">
                      <div class="col-6">Total (<span id="currSet1"></span>)</div>
                      <div class="col-6 text-right"><span id="total"></span></div>
                  </div>
                  <div class="row mb-3" style="border: 3px solid #dc3545;">
                      <a class="col-4 btn btn-danger rounded-0 border-0">Total Due</a>
                      <div class="col-5 px-3 p-2" id="currSet2" ></div>
                      <div class="col-3 text-right px-3 p-2"><span id="finaltotal"></span></div>
                  </div>
                </div>
            </div>

        </form>
    </div>

    <div class="text-center pt-3"><a class="btn btn-warning" id="downloadButton" onclick="javascript:generatePDF();">Generate PDF</a></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
    <script>
        $(function() {
            $('#datepicker').datepicker();
        });

        $("#items").on('click', '.deleteRow', function () {
            console.log("Deleting Row")
            itemAmount = parseInt(document.getElementById('amount').value);

            subtotal = subtotal - itemAmount;
            document.getElementById('subtotal').innerHTML = subtotal;
            document.getElementById("taxAmount").innerHTML = subtotal*.20;
            document.getElementById("total").innerHTML = subtotal*1.20;
            document.getElementById("finaltotal").innerHTML = subtotal*1.20;
            $(this).closest('tr').remove();
        });

        var subtotal = 0;
        var originalAmount=0;
        var curr = 'INR'; //chosen currency
        currencyFunc('INR');
        const api = "https://api.exchangerate-api.com/v4/latest/USD";
        function currencyFunc(newCurr){ //updates chosen currency
            // var table = document.getElementById('table-body');
            // if(table.length > 0){
            //     table.find('tr').each(function (i, el) {
            //         var convertedRate = parseInt($(this).find("#rate").val()) / 80;
            //         var convertedAmount = parseInt($(this).find("#quantity").val()) * convertedRate;
            //         console.log("Converted Rate: ", convertedRate, convertedAmount)
            //         $(this).find("#quantity").val() = convertedAmount
            //         // var $tds = $(this).find('td'),

            //         //     productId = $tds.eq(0).text(),
            //         //     product = $tds.eq(1).text(),
            //         //     Quantity = $tds.eq(2).text();
            //     });
            // }
            
            curr = newCurr;
            originalcurr = document.getElementById("currency").value;
            console.log("currency",originalcurr);
            document.getElementById("currSet1").innerHTML = curr;
            document.getElementById("currSet2").innerHTML = curr;
        }

        Calculate(); // calculate amount of that item
        function Calculate(){
            var quantity = document.getElementById('quantity').value;
            var rate = document.getElementById('rate').value; 
            var amount = parseInt(quantity*rate);
            
            originalAmount = parseInt(document.getElementById('amount').value);
            if(isNaN(originalAmount)){
                originalAmount = 0;
            }
            document.getElementById('amount').value= amount;
            calcTotal(amount);
        }

        function calcTotal(amount){ //calculate total amount
            subtotal = subtotal - originalAmount + parseInt(amount);
            originalAmount=0;
            document.getElementById('subtotal').innerHTML = subtotal;
            document.getElementById("taxAmount").innerHTML = subtotal*.20;
            document.getElementById("total").innerHTML = subtotal*1.20;
            document.getElementById("finaltotal").innerHTML = subtotal*1.20;
        }
        
        function addLine(){ //adds new line for to add items
            var table = document.getElementById("items");
            var row = table.insertRow(1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            cell1.innerHTML = '<div class="form-group"><textarea class="form-control" id="itemName" rows="2" placeholder="Item Decription"></textarea><a class="btn btn-outline-secondary ml-1"  style="border: 1px solid #ced4da;" onclick="duplicate()"><i class="fa fa-copy"></i></a></div> ';
            cell2.innerHTML = '<div class="form-group"><input type="text" class="form-control text-right" id="quantity" value="0.00" required></div> ';
            cell3.innerHTML = '<div class="form-group"><input type="text" class="form-control text-right" id="rate" onblur="Calculate();" value="0.00" required></div> ';
            cell4.innerHTML = '<div class="form-group"><input type="text" class="form-control text-right" id="amount" value="" readonly></div> ';
        }

        function duplicate(){
            console.log("inside duplicate")
            var elem = document.getElementById('item-row');
            var table = document.getElementById('table-body');
            var clone = elem.cloneNode(true); // Creatig of the selected row 
            
            table.appendChild(clone);
        }

        window.html2canvas = html2canvas;
        window.jsPDF = window.jspdf.jsPDF;
        function generatePDF(){
            document.getElementById("downloadButton").innerHTML = "Currently downloading, please wait";

            var invoice = document.getElementById("invoicemain"); //Downloading
            // var doc = new jsPDF('l', 'pt');
            // await html2canvas(invoice, {
            //     // allowTaint: true, useCORS: true,
            //     width: 900, height: 900
            // }).then((canvas) => {
            //     doc.addImage(canvas.toDataURL("image/png"), 'PNG', 10, 10); //Canvas (convert to PNG)
            // })
            // doc.save("invoice.pdf");
            html2canvas( invoice, {
                allowTaint: true,  useCORS: true,  scale: 1
                }).then(canvas => {
                var img = canvas.toDataURL("image/png");
                var doc = new jsPDF();
                doc.getFontSize(11);
                doc.addImage(img, 'PNG', 4, 8, 195, 275);
                doc.save("invoice.pdf");
            });
            
            document.getElementById("downloadButton").innerHTML = "Generate PDF";//End of downloading
        }
    </script>
    
</body>
</html>
